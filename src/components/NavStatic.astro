---
import { getCollection } from "astro:content";
import type { CollectionEntry } from "astro:content";
import Book from "@/components/Book.astro";
import Home from "@/components/Home.astro"
import Chart from "@/components/Chart.astro"
import NavItem from "@/components/NavItem.astro"
import NavLangPicker from "@/components/NavLangPicker.astro"

interface Props {
  blog: CollectionEntry<"blog">[]
}

const pages = await getCollection("pages");
const posts = await getCollection("blog");

const langs = [...new Set(pages.map(({ slug }) => slug.split("/")[0]))];

const [, currentLang, ...slug] = Astro.url.pathname.split("/");

function getLanguageFlags(collection: CollectionEntry<"pages">[]) {
  return collection.reduce<Record<string, string>>((flags, { slug, data }) => {
    flags[slug] = data["global.flag"];
    return flags;
  }, {});
}

let thisPostSlug: string
const flags = getLanguageFlags(pages);

function getTranslatedSlugs(posts: CollectionEntry<"blog">[]) {
  const postType = posts.find(post => {
    const thisPath = Astro.url.pathname.split("/").filter(e=>e).at(-1)
    return post.data.path == thisPath
  })

  const postId = postType?.id.split("/").at(-1) || ""
  thisPostSlug = postId

  return posts.reduce<Record<string, string>>((links, post, i) => {
    if (!post.id.includes(postId)) {
      return links
    }

    const [lang] = post.slug.split("/");
    links[lang] = post.data.path;
    return links;
  }, {});
}

const translatedSlugs = getTranslatedSlugs(posts);
const isBlog = slug.includes("blog");
const withBlog = isBlog ? "blog/" : ""

const {blog} = Astro.props

function addBlogToSlug(post: CollectionEntry<"blog">): string {
  const [lang] = post.slug.split("/")
  return [lang, "blog", post.data.path].join("/")
}
// console.log(blog)
---

<nav class="fixed flex bottom-0 w-full border-t lg:left-0 lg:flex-col lg:h-screen lg:w-auto lg:border-r lg:border-t-transparent border-white/50">
  <NavItem iconElement={Book}>
    {blog.map(post => {
      return <a href={`/${addBlogToSlug(post)}`} class="text-white px-4 py-2">{post.data.h1}</a>
    })}
  </NavItem>

  <NavItem iconElement={Chart}>
    {blog.map(post => {
      return <a href={`/${addBlogToSlug(post)}`} class="text-white">{post.data.h1}</a>
    })}
  </NavItem>

  <a href={`/${currentLang}/`} title="home" class="hover:bg-white/30 grayscale hover:grayscale-0 transition-all">
    <div class="flex p-4 justify-center items-center mt-0 h-full lg:h-auto">
      <Home/>
    </div>
  </a>

  <div class="w-full bg-[#141418] h-auto h-full absolute -z-[1]"></div>
  <div class="w-full bg-[#141418] h-auto h-full  -z-[1]"></div>


  <NavItem iconElement={NavLangPicker} relative={1} fit={1} row={1} right={1}>
    {langs.map(lang => {
      if (lang in translatedSlugs) {}
      else {
        console.error(`Falta traduccion de *${lang}* en ${thisPostSlug}`)
        return 
      }
      if (lang == currentLang) return
      return (
        <a 
          class="flex p-4"
          href={`/${lang}/${withBlog}${isBlog ? translatedSlugs[lang] : slug.join("/")}`}>
          <span class={`fi fi-${flags[lang]} rounded-sm`} style="aspect-ratio: 4/3; width: 2rem;"/>
        </a>
      )
    })}
  </NavItem>
</nav>

<style>
  .fi:before {
    visibility: hidden;
  }

  div:has(+ *:checked) {
    filter: grayscale(0);
  } 

  @media (width < 1024px) {
    .sel + div {
      pointer-events: none;
      transform: translateY(150%);
    }

    .sel:checked ~ div {
      pointer-events: inherit;
      transform: translateY(-100%);

    }
  }

  @media (width > 1024px) {
    .sel + div {
      pointer-events: none;
      transform: translateX(-100%);
    }

    .sel:checked + div {
      pointer-events: inherit;
      transform: translateX(100%);
    }
  }


.sel:checked + div a:hover {

  filter: drop-shadow(1px 1px 0 rgba(255, 255, 255, .3)) 
          drop-shadow(-1px -1px 0 rgba(255, 255, 255, .3)) drop-shadow(0 0 5px white);
}


  .country-selector:hover ~div{
    transform: translateX(100%);
  }

  .country-selector ~div:hover{
    transform: translateX(100%);
  }

  .country-selector ~div a:hover{
  filter: drop-shadow(1px 1px 0 rgba(255, 255, 255, .3)) 
          drop-shadow(-1px -1px 0 rgba(255, 255, 255, .3)) drop-shadow(0 0 5px white);
  }

</style>
